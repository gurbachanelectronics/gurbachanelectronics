name: Keep Render App Alive

# This workflow runs every minute to ping your Render app
# Note: GitHub Actions minimum cron interval is 5 minutes, but we set it to every minute
# GitHub will automatically round it to 5 minutes, but this ensures maximum frequency
# Render spins down after 15 minutes of inactivity, so frequent pings keep it awake

on:
  schedule:
    # Run every minute (GitHub will enforce 5-minute minimum, but this is the closest we can get)
    # Cron format: minute hour day month day-of-week
    # GitHub Actions uses UTC time and can delay by up to 15 minutes
    - cron: '* * * * *'  # Every minute (GitHub rounds to 5 min minimum)
  workflow_dispatch: # Allows manual trigger from GitHub Actions tab
  push:
    branches:
      - main
    # Trigger on ANY push to main, not just workflow file changes
    # This ensures workflow runs immediately after any commit
  repository_dispatch: # Allows external triggers via API

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    
    steps:
      - name: Check Workflow Trigger
        run: |
          echo "ğŸ” Workflow Trigger Information:"
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "SHA: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Run Number: ${{ github.run_number }}"
          echo "Run Attempt: ${{ github.run_attempt }}"
          echo "---"
        
      - name: Ping Render App
        id: ping
        run: |
          echo "ğŸ”„ Keep-Alive Ping Started"
          echo "â° UTC Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "â° Local Time: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ğŸ“ Pinging Render app..."
          
          # Render app URL
          RENDER_URL="https://gurbachanelectronics.onrender.com"
          echo "ğŸŒ URL: $RENDER_URL"
          
          # Ping the app with detailed output
          echo "ğŸ“¡ Sending HTTP request..."
          response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 --connect-timeout 10 "$RENDER_URL" 2>&1 || echo "000")
          curl_exit_code=$?
          
          echo "ğŸ“Š Response Code: $response"
          echo "ğŸ“Š Curl Exit Code: $curl_exit_code"
          
          # Also get full response for debugging
          full_response=$(curl -s -w "\nHTTP_CODE:%{http_code}\nTIME_TOTAL:%{time_total}s" --max-time 30 "$RENDER_URL" 2>&1 || echo "ERROR")
          echo "ğŸ“„ Full Response (first 200 chars):"
          echo "$full_response" | head -c 200
          echo ""
          
          if [ "$response" = "200" ] || [ "$response" = "301" ] || [ "$response" = "302" ]; then
            echo "âœ… SUCCESS! App is awake (HTTP $response)"
            echo "ğŸ• Next scheduled ping in ~5 minutes (GitHub Actions minimum)"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ WARNING: Got HTTP $response (Exit: $curl_exit_code)"
            echo "ğŸ’¡ App might be spinning up (this is normal on first ping)"
            echo "ğŸ’¡ Or Render might be experiencing issues"
            echo "status=warning" >> $GITHUB_OUTPUT
            # Don't fail the workflow - Render might be waking up
          fi
          
          echo "âœ… Keep-alive ping completed at $(date '+%Y-%m-%d %H:%M:%S')"
        
      - name: Workflow Status
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š KEEP-ALIVE WORKFLOW STATUS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Workflow completed successfully"
          echo "ğŸ”„ Schedule: Every minute (GitHub enforces 5-min minimum)"
          echo "ğŸ¯ Trigger: Scheduled cron + Push to main + Manual"
          echo "ğŸ’¡ Your Render app will stay awake 24/7!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“ To verify this is working:"
          echo "   1. Go to: https://github.com/${{ github.repository }}/actions"
          echo "   2. Check 'Keep Render App Alive' workflow runs regularly"
          echo "   3. Each run should show 'âœ… SUCCESS! App is awake'"
          echo ""
          echo "ğŸ”§ If workflow is not running:"
          echo "   1. Check GitHub Actions is enabled: Repo â†’ Settings â†’ Actions"
          echo "   2. Check workflow file exists: .github/workflows/keep-alive.yml"
          echo "   3. Manually trigger: Actions tab â†’ Keep Render App Alive â†’ Run workflow"
